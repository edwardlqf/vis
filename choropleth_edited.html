<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<!-- add title -->
    <title>Q5</title>

    <!-- import required libraries here -->
	<script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="../lib/topojson.v2.min.js"></script>
    <script type="text/javascript" src="../lib/d3-geo-projection.v2.min.js"></script>
    <script type="text/javascript" src="../lib/d3-legend.min.js"></script>
	<script type="text/javascript" src="../lib/d3-tip.min.js"></script>

	<style>
    .country {
    stroke: #000;
    stroke-width:0.25px;
}
    .country:hover{
    opacity: .6;
}
    .d3-tip {
        line-height: 1;
        padding: 12px;
        background: rgba(43,43,43, 0.8);
        color: #fff;
        border-radius: 2px;
}
    .caption {
        text-anchor: middle;
        font-size: 12;
        font-weight: bold;
        color: #000;
}
    .lgd-marks {
        text-anchor: left;
        color: #000;
}
    h2 {
        position: absolute;
        left: 320px;
        top:  15px;
}	
    #selectButton{
        position:absolute;
	    top:70px;
	    left:40px;
    }

	</style>
</head>

<body>
    <!-- Add heading for the visualization -->
    <h2>Average Rating of Board Games Across the World</h2>
    
	<!-- Dropdown -->
    <select id="selectButton"></select>
    
	<!-- append visualization svg to this div-->
    <div id="choropleth"></div>

    <script>
// defining global variables
var margin = {top: 50, right: 50, bottom: 50, left: 50};
var width = 960 - margin.left - margin.right;
var height = 600 - margin.top - margin.bottom;
var projection = d3.geoEqualEarth();
var path = d3.geoPath(projection);


var tip = d3.tip().attr('class', 'd3-tip').offset([10,10]) // create a tip where each property is on its own line
				  .html(function(d) { 
						return "<strong style='color:lightblue'>Country: </strong><span style='color:white'>"+ d.properties.name + "</span><br>" +
		"<strong style='color:lightblue'>anger_intensity: </strong><span style='color:white'>" + d.properties.anger_intensity +"</span><br>" +
		"<strong style='color:lightblue'>valence_intensity: </strong><span style='color:white'>" + d.properties.valence_intensity +"</span><br>" +
		"<strong style='color:lightblue'>fear_intensity: </strong><span style='color:white'>" + d.properties.fear_intensity +"</span><br>" +
		"<strong style='color:lightblue'>sadness_intensity : </strong><span style='color:white'>" + d.properties.sadness_intensity +"</span><br>" +
		"<strong style='color:lightblue'>joy_intensity: </strong><span style='color:white'>" + d.properties.joy_intensity + "</span><br>"
		})  
var world = [] // for mapping
var game_data = [] //rename to {key: "country", value: {anger_intensity: 0.428, valence_intensity: 0.569, fear_intensity: 0.329, sadness_intensity: 0.334, joy_intensity: 0.381}
var game_arr = ['valence_intensity','anger_intensity','fear_intensity','sadness_intensity','joy_intensity']

var svg = d3.select("body")
		.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + ", "+ 1.5*margin.bottom+")")
		.call(tip);	

Promise.all([d3.json("world_countries.json"),d3.csv("etl/twitter/sentiment/openicpsr/country_date_sentiment.csv")
		.then(function(csv_data){
			game_data = d3.nest()
				.key(function(d) {return d.country_region;})
				.rollup(function(d) {
					return {
						anger_intensity: d3.sum(d, function(e) { return e.anger_intensity; }),
						valence_intensity: d3.sum(d, function(e) { return e.valence_intensity; }),
						fear_intensity: d3.sum(d, function(e) { return e.fear_intensity; }),
						sadness_intensity: d3.sum(d, function(e) { return e.sadness_intensity; }),
						joy_intensity: d3.sum(d, function(e) { return e.joy_intensity; })     
					};
				})
				.entries(csv_data)})
			])
.then(function(world_map){
	world = world_map[0].features; // adding features from topojson
	
	//world.properties["game"] =  game_data.anger_intensity 
	for (var j = 0; j < world.length; j++) {
	for (var i = 0; i < game_data.length; i++) {
		if (world[j].properties.name == game_data[i].key) { 
			//console.log(game_data[i].value.anger_intensity)
			world[j].properties["anger_intensity"] =  game_data[i].value.anger_intensity 
			world[j].properties["valence_intensity"] = game_data[i].value.valence_intensity
			world[j].properties["fear_intensity"] =  game_data[i].value.fear_intensity 
			world[j].properties["sadness_intensity"] = game_data[i].value.sadness_intensity
			world[j].properties['joy_intensity'] = game_data[i].value.joy_intensity
		}
		} 
	}

	console.log(world)

    svg.append("g") // construct svg after reading data
    .attr("class", "legendQuant")
    .attr("transform", "translate(20,320)");

    svg.append("text")
    .attr("transform", "translate(-5,-10)")
    .text("Select Board Game: ");
    
    d3.select("#selectButton") // positioning select button
        .selectAll('myOptions')
        .data(game_arr)
        .enter()
        .append('option')
        .text(function (d) { return d; }) 
        .attr("value", function (d) { return d; })
		.attr("y", 20) // adding to avoid any overlap

    var country_by_game = [] //countries by metric
    function update(selectedGame) { 
		//console.log(game_data)

		country_by_game = game_data.map(function(k) {
			//console.log(k.value[selectedGame])
			return {
			country: k.key,
			values: k.value[selectedGame]
			}
		});
        // country_by_game = game_data.filter(function( d ) {
        //     return d.game == selectedGame;
        // });
		//console.log(country_by_game)    

		var color = d3.scaleQuantize()
					.domain([
					d3.min(country_by_game, function(d) { return d.values; }), 
					d3.max(country_by_game, function(d) { return d.values; })
					])
					.range(['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#006d2c','#00441b']); // color scheme 
					
					//["rgb(254,237,222)","rgb(253,190,133)","rgb(253,141,60)","rgb(217,71,1)"]
					
		// create legend
		var legend = d3.legendColor()
		.cells(4)
		.shapeWidth(20)
		.orient('vertical')
		.title("Average Rating:")
		.scale(color)
		
		svg.select(".legendQuant")
		.call(legend);
		
		// coloring the map
		svg.select(".legendQuant")
		.call(legend);
			svg.append("g")
				.attr("class", "name")
				.selectAll("path")
				.data(world)
				.enter().append("path")
				.attr("d", path)
				.style("fill", function(d){
					for (var i = 0; i < country_by_game.length; i++) {
						if (d.properties.name == country_by_game[i].country) { 
							//console.log((country_by_game[i].values))
							return(color(country_by_game[i].values));
						}
					} 
				})
			.on('mouseover', tip.show) 
			.on('mouseout', tip.hide)
			.call(tip);
		}
	
	//selectedGame = 'anger_intensity'
    update(game_arr[0]); // displaying default option

	// upon option being selected, update map
    d3.select("#selectButton").on("change", function(d) {  
    var selectedOption = d3.select(this).property("value")
    update(selectedOption);
    })

})

    </script>

</body>

</html>